{% extends "layout.html" %}

{% block content %}
<div class="space-y-8">

    <!-- Header -->
    <div class="border-b border-surface-200 pb-6">
        <div class="flex items-center gap-3 mb-2">
            <i data-lucide="book-a" class="w-5 h-5 text-copper-600"></i>
            <p class="text-sm font-sans font-medium text-copper-600 tracking-wide uppercase">Administration</p>
        </div>
        <h1 class="font-serif text-3xl text-surface-900">Synonym Management</h1>
        <p class="mt-2 font-sans text-surface-500 text-sm">Configure search term synonyms for improved query matching</p>
    </div>

    <!-- Status Messages -->
    <div id="status-messages">
        {% if success_message %}
        <div class="p-4 bg-surface-50 border border-green-200 rounded-lg mb-4">
            <div class="flex items-center gap-2">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600 flex-shrink-0"></i>
                <p class="font-sans text-sm text-green-800">{{ success_message }}</p>
            </div>
        </div>
        {% endif %}

        {% if errors %}
        <div class="p-4 bg-surface-50 border border-red-200 rounded-lg mb-4">
            <div class="flex items-start gap-2">
                <i data-lucide="alert-circle" class="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0"></i>
                <div>
                    {% for error in errors %}
                    <p class="font-sans text-sm text-red-800">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-surface-0 border border-surface-200 rounded-lg p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-sans text-xs text-surface-400 uppercase tracking-wide">Built-in Terms</p>
                    <p class="font-sans text-2xl font-semibold text-surface-800 mt-1">{{ builtin_count }}</p>
                </div>
                <div class="p-2.5 bg-surface-50 border border-surface-200 rounded-lg">
                    <i data-lucide="lock" class="w-5 h-5 text-surface-400"></i>
                </div>
            </div>
        </div>

        <div class="bg-surface-0 border border-surface-200 rounded-lg p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-sans text-xs text-surface-400 uppercase tracking-wide">Custom Terms</p>
                    <p class="font-sans text-2xl font-semibold text-copper-600 mt-1">{{ custom_count }}</p>
                </div>
                <div class="p-2.5 bg-copper-50 border border-copper-200 rounded-lg">
                    <i data-lucide="plus" class="w-5 h-5 text-copper-500"></i>
                </div>
            </div>
        </div>

        <div class="bg-surface-0 border border-surface-200 rounded-lg p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-sans text-xs text-surface-400 uppercase tracking-wide">Total Active</p>
                    <p class="font-sans text-2xl font-semibold text-surface-800 mt-1">{{ total_count }}</p>
                </div>
                <div class="p-2.5 bg-surface-50 border border-surface-200 rounded-lg">
                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Upload Section -->
        <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
            <h2 class="font-serif text-lg text-surface-800 mb-5 flex items-center gap-2">
                <i data-lucide="upload" class="w-5 h-5 text-copper-600"></i>
                Upload Synonyms
            </h2>

            <form id="upload-form"
                  hx-post="/admin/synonyms/upload"
                  hx-target="#upload-result"
                  hx-swap="innerHTML"
                  hx-encoding="multipart/form-data"
                  class="space-y-4">

                <div>
                    <label class="block font-sans text-sm font-medium text-surface-700 mb-2">Select File</label>
                    <input type="file"
                           name="file"
                           accept=".csv,.json"
                           class="block w-full font-sans text-sm text-surface-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-lg file:border-0
                                  file:text-sm file:font-medium
                                  file:bg-copper-50 file:text-copper-700
                                  hover:file:bg-copper-100
                                  cursor-pointer border border-surface-300 rounded-lg bg-surface-0" />
                    <p class="mt-1 font-sans text-xs text-surface-400">Accepts .csv or .json files (max 1MB)</p>
                </div>

                <div class="flex items-center">
                    <input type="checkbox"
                           name="replace_all"
                           id="replace_all"
                           value="true"
                           class="h-4 w-4 text-copper-600 border-surface-300 rounded focus:ring-copper-500" />
                    <label for="replace_all" class="ml-2 font-sans text-sm text-surface-600">
                        Replace all custom synonyms (otherwise merge)
                    </label>
                </div>

                <div class="flex gap-3">
                    <button type="button"
                            hx-post="/admin/synonyms/preview"
                            hx-target="#preview-result"
                            hx-swap="innerHTML"
                            hx-encoding="multipart/form-data"
                            hx-include="[name='file']"
                            class="px-4 py-2 bg-surface-100 text-surface-700 font-sans text-sm font-medium rounded-lg hover:bg-surface-200 border border-surface-200 transition-colors">
                        Preview
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-copper-600 hover:bg-copper-700 text-white font-sans text-sm font-medium rounded-lg transition-colors inline-flex items-center">
                        <span class="htmx-indicator mr-2">
                            <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                        </span>
                        Upload & Apply
                    </button>
                </div>
            </form>

            <!-- Preview Result -->
            <div id="preview-result" class="mt-4"></div>

            <!-- Upload Result -->
            <div id="upload-result" class="mt-4"></div>

            <!-- File Format Help -->
            <div class="mt-6 p-4 bg-surface-50 border border-surface-100 rounded-lg">
                <h3 class="font-sans text-sm font-medium text-surface-700 mb-3">File Format Examples</h3>

                <div class="space-y-3">
                    <div>
                        <p class="font-sans text-xs font-medium text-surface-500 uppercase tracking-wide">JSON Format:</p>
                        <pre class="mt-1 font-mono text-xs bg-surface-0 border border-surface-200 p-2 rounded-lg overflow-x-auto text-surface-700">{
  "vacation": ["annual leave", "pto", "time off"],
  "overtime": ["ot", "extra hours"]
}</pre>
                    </div>

                    <div>
                        <p class="font-sans text-xs font-medium text-surface-500 uppercase tracking-wide">CSV Format:</p>
                        <pre class="mt-1 font-mono text-xs bg-surface-0 border border-surface-200 p-2 rounded-lg overflow-x-auto text-surface-700">vacation,annual leave,pto,time off
overtime,ot,extra hours</pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Single Synonym -->
        <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
            <h2 class="font-serif text-lg text-surface-800 mb-5 flex items-center gap-2">
                <i data-lucide="plus" class="w-5 h-5 text-copper-600"></i>
                Add Single Entry
            </h2>

            <form hx-post="/admin/synonyms/add"
                  hx-target="#custom-synonyms-list"
                  hx-swap="outerHTML"
                  class="space-y-4">

                <div>
                    <label class="block font-sans text-sm font-medium text-surface-700 mb-1">Canonical Term</label>
                    <input type="text"
                           name="canonical_term"
                           placeholder="e.g., vacation"
                           required
                           class="w-full px-3 py-2 border border-surface-300 rounded-lg bg-surface-0 font-sans text-sm focus:border-copper-500 focus:ring-0" />
                    <p class="mt-1 font-sans text-xs text-surface-400">The main term that synonyms will map to</p>
                </div>

                <div>
                    <label class="block font-sans text-sm font-medium text-surface-700 mb-1">Synonyms</label>
                    <input type="text"
                           name="synonyms"
                           placeholder="e.g., annual leave, pto, time off"
                           required
                           class="w-full px-3 py-2 border border-surface-300 rounded-lg bg-surface-0 font-sans text-sm focus:border-copper-500 focus:ring-0" />
                    <p class="mt-1 font-sans text-xs text-surface-400">Comma-separated list of synonyms</p>
                </div>

                <button type="submit"
                        class="px-4 py-2 bg-copper-600 hover:bg-copper-700 text-white font-sans text-sm font-medium rounded-lg transition-colors inline-flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Add Synonym
                </button>
            </form>

            <!-- Actions -->
            <div class="mt-6 pt-5 border-t border-surface-200">
                <h3 class="font-sans text-xs font-medium text-surface-400 uppercase tracking-wide mb-3">Actions</h3>
                <div class="flex flex-wrap gap-2">
                    <a href="/admin/synonyms/download?include_builtin=false"
                       class="px-3 py-2 bg-surface-50 text-surface-600 font-sans text-sm font-medium rounded-lg hover:bg-surface-100 border border-surface-200 transition-colors inline-flex items-center gap-1.5">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Download Custom
                    </a>
                    <a href="/admin/synonyms/download?include_builtin=true"
                       class="px-3 py-2 bg-surface-50 text-surface-600 font-sans text-sm font-medium rounded-lg hover:bg-surface-100 border border-surface-200 transition-colors inline-flex items-center gap-1.5">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Download All
                    </a>
                    <button hx-post="/admin/synonyms/reload"
                            hx-target="#status-messages"
                            hx-swap="innerHTML"
                            class="px-3 py-2 bg-surface-50 text-surface-600 font-sans text-sm font-medium rounded-lg hover:bg-surface-100 border border-surface-200 transition-colors inline-flex items-center gap-1.5">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Reload Cache
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Synonyms List -->
    <div id="custom-synonyms-list" class="bg-surface-0 border border-surface-200 rounded-lg p-6">
        <h2 class="font-serif text-lg text-surface-800 mb-5 flex items-center gap-2">
            <i data-lucide="plus" class="w-5 h-5 text-copper-600"></i>
            Custom Synonyms ({{ custom_count }})
        </h2>

        {% if custom_synonyms %}
        <div class="overflow-x-auto">
            <table class="w-full font-sans text-sm">
                <thead>
                    <tr class="text-left text-surface-400 border-b border-surface-200">
                        <th class="pb-3 font-medium text-xs uppercase tracking-wide">Canonical Term</th>
                        <th class="pb-3 font-medium text-xs uppercase tracking-wide">Synonyms</th>
                        <th class="pb-3 font-medium text-xs uppercase tracking-wide w-20">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-surface-100">
                    {% for canonical, syns in custom_synonyms.items() %}
                    <tr class="hover:bg-surface-50">
                        <td class="py-3 font-medium text-surface-800">{{ canonical }}</td>
                        <td class="py-3 text-surface-600">
                            {% for syn in syns %}
                            <span class="inline-block px-2 py-0.5 bg-copper-50 text-copper-700 text-xs rounded border border-copper-100 mr-1 mb-1">{{ syn }}</span>
                            {% endfor %}
                        </td>
                        <td class="py-3">
                            <button hx-delete="/admin/synonyms/{{ canonical }}"
                                    hx-target="#custom-synonyms-list"
                                    hx-swap="outerHTML"
                                    hx-confirm="Delete synonym '{{ canonical }}'?"
                                    class="text-red-500 hover:text-red-700 transition-colors inline-flex items-center gap-1">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="font-sans text-surface-400 text-sm">No custom synonyms defined. Upload a file or add entries above.</p>
        {% endif %}
    </div>

    <!-- Built-in Synonyms (Read-only) -->
    <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
        <h2 class="font-serif text-lg text-surface-800 mb-5 flex items-center gap-2">
            <i data-lucide="lock" class="w-5 h-5 text-surface-400"></i>
            Built-in Synonyms ({{ builtin_count }})
            <span class="font-sans text-xs font-normal text-surface-400 ml-1">(read-only)</span>
        </h2>

        <div class="overflow-x-auto max-h-96 overflow-y-auto">
            <table class="w-full font-sans text-sm">
                <thead class="sticky top-0 bg-surface-0">
                    <tr class="text-left text-surface-400 border-b border-surface-200">
                        <th class="pb-3 font-medium text-xs uppercase tracking-wide">Canonical Term</th>
                        <th class="pb-3 font-medium text-xs uppercase tracking-wide">Synonyms</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-surface-100">
                    {% for canonical, syns in builtin_synonyms.items() %}
                    <tr class="hover:bg-surface-50">
                        <td class="py-3 font-medium text-surface-800">{{ canonical }}</td>
                        <td class="py-3 text-surface-600">
                            {% for syn in syns %}
                            <span class="inline-block px-2 py-0.5 bg-surface-100 text-surface-600 text-xs rounded border border-surface-200 mr-1 mb-1">{{ syn }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}
