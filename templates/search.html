{% extends "layout.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div>
        <div class="flex items-center gap-3 mb-1">
            <i data-lucide="search" class="w-6 h-6 text-copper-600"></i>
            <h1 class="text-3xl font-serif text-surface-100">Search</h1>
        </div>
        <p class="text-surface-400 font-sans text-sm ml-9">Search across all indexed collective agreements</p>
    </div>

    <!-- Search Form Card -->
    <div class="bg-surface-800 border border-surface-700 rounded-lg p-6">
        <form hx-get="/search"
              hx-target="#search-results"
              hx-indicator="#search-spinner"
              hx-trigger="submit"
              class="space-y-5">

            <!-- Search Bar -->
            <div class="flex gap-3">
                <div class="flex-1 relative">
                    <label for="query" class="sr-only">Search query</label>
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-4 h-4 text-surface-400"></i>
                    </div>
                    <input type="text"
                           name="q"
                           id="query"
                           value="{{ query }}"
                           placeholder="Search for terms, &quot;quoted phrases&quot;, or topics..."
                           class="block w-full border border-surface-600 rounded-lg bg-surface-800 focus:border-copper-500 focus:ring-1 focus:ring-copper-500 text-surface-100 placeholder:text-surface-400 pl-11 pr-4 py-3 font-sans text-sm">
                </div>
                <button type="submit"
                        class="inline-flex items-center px-5 py-3 bg-copper-600 hover:bg-copper-700 text-white text-sm font-medium font-sans rounded-lg transition-colors flex-shrink-0">
                    <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                    Search
                    <span id="search-spinner" class="htmx-indicator ml-2">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                    </span>
                </button>
            </div>

            <!-- Filters Row -->
            <div class="flex flex-wrap items-center gap-x-6 gap-y-3 pt-4 border-t border-surface-700">

                <!-- Document Filter -->
                <div class="flex items-center gap-2">
                    <label for="file_id" class="text-xs font-medium font-sans text-surface-400 uppercase tracking-wide">Document</label>
                    <select name="file_id" id="file_id"
                            class="border border-surface-600 rounded-lg bg-surface-800 focus:border-copper-500 focus:ring-1 focus:ring-copper-500 text-surface-100 text-sm font-sans py-1.5 pl-3 pr-8">
                        <option value="">All Documents</option>
                        {% for file in files %}
                        <option value="{{ file.id }}" {% if file_id == file.id %}selected{% endif %}>
                            {{ file.filename }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Divider -->
                <div class="w-px h-6 bg-surface-700 hidden sm:block"></div>

                <!-- Match Mode Toggle -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium font-sans text-surface-400 uppercase tracking-wide">Match</span>
                    <div class="flex rounded-lg border border-surface-700 overflow-hidden">
                        <label class="relative inline-flex items-center">
                            <input type="radio" name="mode" value="and"
                                   {% if mode == 'and' %}checked{% endif %}
                                   class="sr-only peer">
                            <span class="px-3 py-1.5 text-xs font-medium font-sans cursor-pointer transition-colors
                                         bg-surface-800 text-surface-300
                                         peer-checked:bg-copper-600 peer-checked:text-white">
                                All Terms (AND)
                            </span>
                        </label>
                        <label class="relative inline-flex items-center border-l border-surface-700">
                            <input type="radio" name="mode" value="or"
                                   {% if mode == 'or' %}checked{% endif %}
                                   class="sr-only peer">
                            <span class="px-3 py-1.5 text-xs font-medium font-sans cursor-pointer transition-colors
                                         bg-surface-800 text-surface-300
                                         peer-checked:bg-copper-600 peer-checked:text-white">
                                Any Term (OR)
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Divider -->
                <div class="w-px h-6 bg-surface-700 hidden sm:block"></div>

                <!-- Search Mode Toggle -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium font-sans text-surface-400 uppercase tracking-wide">Mode</span>
                    <div class="flex rounded-lg border border-surface-700 overflow-hidden">
                        <label class="relative inline-flex items-center">
                            <input type="radio" name="search_mode" value="ai"
                                   {% if search_mode == 'ai' %}checked{% endif %}
                                   class="sr-only peer">
                            <span class="px-3 py-1.5 text-xs font-medium font-sans cursor-pointer transition-colors flex items-center gap-1.5
                                         bg-surface-800 text-surface-300
                                         peer-checked:bg-copper-600 peer-checked:text-white">
                                <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
                                AI Analysis
                            </span>
                        </label>
                        <label class="relative inline-flex items-center border-l border-surface-700">
                            <input type="radio" name="search_mode" value="text"
                                   {% if search_mode != 'ai' %}checked{% endif %}
                                   class="sr-only peer">
                            <span class="px-3 py-1.5 text-xs font-medium font-sans cursor-pointer transition-colors flex items-center gap-1.5
                                         bg-surface-800 text-surface-300
                                         peer-checked:bg-copper-600 peer-checked:text-white">
                                <i data-lucide="type" class="w-3.5 h-3.5"></i>
                                Text Search
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Divider -->
                <div class="w-px h-6 bg-surface-700 hidden sm:block"></div>

                <!-- Synonym Expansion Toggle -->
                <div class="flex items-center gap-2" id="synonym-toggle">
                    <label for="expand_synonyms" class="flex items-center cursor-pointer gap-2">
                        <input type="checkbox"
                               name="expand_synonyms"
                               id="expand_synonyms"
                               value="true"
                               {% if expand_synonyms %}checked{% endif %}
                               class="sr-only peer">
                        <div class="toggle-track"></div>
                        <span class="text-xs font-medium font-sans text-surface-300">Synonyms</span>
                    </label>
                    <div class="relative group">
                        <i data-lucide="info" class="w-3.5 h-3.5 text-surface-400 cursor-help"></i>
                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-surface-800 text-white text-xs font-sans rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-10">
                            Expands search terms with related words<br>(e.g., "vacation" also searches "PTO", "annual leave")
                        </div>
                    </div>
                </div>

                <!-- Tip -->
                <div class="text-xs font-sans text-surface-400 flex items-center gap-1.5 ml-auto">
                    <i data-lucide="info" class="w-3.5 h-3.5"></i>
                    Use "quoted phrases" for exact matches
                </div>
            </div>
        </form>
    </div>

    <!-- Export Buttons -->
    {% if query and results %}
    <div class="flex justify-end gap-2">
        <a href="/search/export?q={{ query | urlencode }}&mode={{ mode }}&format=html{% if file_id %}&file_id={{ file_id }}{% endif %}"
           class="inline-flex items-center px-4 py-2 border border-surface-700 bg-surface-800 hover:bg-surface-700 text-surface-200 text-xs font-medium font-sans rounded-lg transition-colors">
            <i data-lucide="download" class="w-3.5 h-3.5 mr-1.5"></i>
            Export HTML
        </a>
        <a href="/search/export?q={{ query | urlencode }}&mode={{ mode }}&format=docx{% if file_id %}&file_id={{ file_id }}{% endif %}"
           class="inline-flex items-center px-4 py-2 border border-surface-700 bg-surface-800 hover:bg-surface-700 text-surface-200 text-xs font-medium font-sans rounded-lg transition-colors">
            <i data-lucide="download" class="w-3.5 h-3.5 mr-1.5"></i>
            Export DOCX
        </a>
    </div>
    {% endif %}

    <!-- Search Results -->
    <div id="search-results">
        {% if search_mode == 'ai' %}
            {% include "components/search_ai_results.html" %}
        {% else %}
            {% include "components/search_results.html" %}
        {% endif %}
    </div>
</div>
{% endblock %}
