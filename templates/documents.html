{% extends "layout.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-serif text-surface-100">Documents</h1>
            <p class="text-sm text-surface-400 mt-1">Manage your PDF collective agreements</p>
        </div>
        <div class="flex gap-2">
            <button hx-post="/documents/scan"
                    hx-target="#documents-table"
                    hx-indicator="#scan-spinner"
                    class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg bg-copper-600 hover:bg-copper-700 text-white transition-colors">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                Scan
                <span id="scan-spinner" class="htmx-indicator">
                    <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                </span>
            </button>
            <button type="button" onclick="startBatchIndex()"
                    id="index-all-btn"
                    class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg border border-surface-700 bg-surface-800 hover:bg-surface-700 text-surface-200 transition-colors">
                <i data-lucide="database" class="w-4 h-4"></i>
                Index All
            </button>
        </div>
    </div>

    <!-- Batch Indexing Progress Bar (hidden by default) -->
    <div id="index-progress" class="hidden bg-surface-800 border border-surface-700 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
                <i data-lucide="loader-2" class="w-4 h-4 text-copper-600 animate-spin" id="index-progress-spinner"></i>
                <span class="text-sm font-medium text-surface-200" id="index-progress-text">Preparing...</span>
            </div>
            <span class="text-xs text-surface-400" id="index-progress-count"></span>
        </div>
        <div class="w-full bg-surface-700 rounded-full h-2">
            <div class="bg-copper-600 h-2 rounded-full transition-all duration-300" id="index-progress-bar" style="width: 0%"></div>
        </div>
        <p class="text-xs text-surface-400 mt-1.5" id="index-progress-file"></p>
    </div>

    <!-- Documents Table -->
    <div class="bg-surface-800 border border-surface-700 rounded-lg overflow-hidden">
        <div id="documents-table">
            {% if documents %}
            <table class="min-w-full divide-y divide-surface-700">
                <thead>
                    <tr class="border-b border-surface-700">
                        <th class="px-6 py-3 text-left text-xs font-medium text-surface-400 uppercase tracking-wider">Document</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-surface-400 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-surface-400 uppercase tracking-wider">Access</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-surface-400 uppercase tracking-wider">Pages</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-surface-400 uppercase tracking-wider">Indexed</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-surface-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-surface-700">
                    {% for doc in documents %}
                    {% include "components/document_row.html" %}
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-16">
                <div class="mx-auto h-14 w-14 bg-surface-800 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="file-text" class="w-6 h-6 text-surface-400"></i>
                </div>
                <h3 class="text-sm font-medium text-surface-100">No documents found</h3>
                <p class="mt-1.5 text-sm text-surface-400">
                    Place PDF files in <code class="bg-surface-800 px-1.5 py-0.5 rounded text-copper-400 text-xs font-mono">data/agreements/</code> and click "Scan"
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
function startBatchIndex() {
    const btn = document.getElementById('index-all-btn');
    const progress = document.getElementById('index-progress');
    const progressText = document.getElementById('index-progress-text');
    const progressCount = document.getElementById('index-progress-count');
    const progressBar = document.getElementById('index-progress-bar');
    const progressFile = document.getElementById('index-progress-file');
    const spinner = document.getElementById('index-progress-spinner');

    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    progress.classList.remove('hidden');
    progressText.textContent = 'Starting batch indexing...';
    progressBar.style.width = '0%';

    const evtSource = new EventSource('/documents/index-all-stream');

    evtSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'start') {
            progressText.textContent = 'Indexing documents...';
            progressCount.textContent = '0 / ' + data.total;
        }
        else if (data.type === 'progress') {
            const pct = Math.round((data.current / data.total) * 100);
            progressBar.style.width = pct + '%';
            progressText.textContent = 'Indexing ' + data.current + ' of ' + data.total + '...';
            progressCount.textContent = data.indexed + ' indexed, ' + data.errors + ' errors';
            progressFile.textContent = 'Current: ' + data.filename;
        }
        else if (data.type === 'complete') {
            evtSource.close();
            progressBar.style.width = '100%';
            spinner.classList.add('hidden');

            if (data.total === 0) {
                progressText.textContent = 'No pending documents to index.';
                progressBar.classList.remove('bg-copper-600');
                progressBar.classList.add('bg-surface-400');
            } else {
                progressText.textContent = 'Complete! ' + data.indexed + ' indexed, ' + data.errors + ' errors.';
                progressBar.classList.remove('bg-copper-600');
                progressBar.classList.add('bg-emerald-500');
            }
            progressFile.textContent = '';
            progressCount.textContent = '';
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');

            // Reload the documents table
            setTimeout(function() { window.location.reload(); }, 1500);
        }
    };

    evtSource.onerror = function() {
        evtSource.close();
        progressText.textContent = 'Connection lost. Refresh the page to see results.';
        spinner.classList.add('hidden');
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
    };
}
</script>
{% endblock %}
