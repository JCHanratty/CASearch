{% extends "layout.html" %}

{% block content %}
<div class="space-y-8">

    <!-- Page Header -->
    <div>
        <div class="flex items-center gap-3 mb-1">
            <i data-lucide="columns-2" class="w-6 h-6 text-copper-600"></i>
            <h1 class="text-3xl font-serif text-surface-900">Compare Documents</h1>
        </div>
        <p class="text-sm text-surface-500 font-sans ml-9">AI-powered comparison across collective agreements</p>
    </div>

    <!-- Selection Form Card -->
    <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
        <form id="compare-form"
              hx-get="/compare/results"
              hx-target="#compare-results"
              hx-indicator="#compare-spinner"
              class="space-y-6">

            <!-- Document Selection -->
            <div>
                <label class="block text-sm font-medium text-surface-700 mb-2 font-sans">Select Documents to Compare <span class="text-surface-400 font-normal">(at least 2)</span></label>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1 max-h-64 overflow-y-auto border border-surface-200 rounded-lg p-3 bg-surface-50">
                    {% for doc in documents %}
                    <label class="flex items-center gap-2.5 px-2.5 py-2 rounded-md hover:bg-surface-100 cursor-pointer transition-colors">
                        <input type="checkbox"
                               name="doc_ids"
                               value="{{ doc.id }}"
                               class="h-4 w-4 text-copper-600 focus:ring-copper-500 border-surface-300 rounded shrink-0">
                        <span class="text-sm text-surface-700 truncate font-sans" title="{{ doc.filename }}">{{ doc.filename }}</span>
                    </label>
                    {% endfor %}
                </div>
                {% if not documents %}
                <p class="text-sm text-surface-400 italic mt-2 font-sans">No indexed documents available.</p>
                {% endif %}
            </div>

            <!-- Topic Input -->
            <div>
                <label for="topic" class="block text-sm font-medium text-surface-700 mb-1.5 font-sans">Topic to Compare</label>
                <input type="text"
                       name="topic"
                       id="topic"
                       placeholder="e.g., wages, overtime, vacation, sick leave, grievance procedure"
                       required
                       class="block w-full px-4 py-2.5 border border-surface-300 rounded-lg bg-surface-0 text-surface-900 placeholder-surface-400 focus:border-copper-500 focus:ring-1 focus:ring-copper-500 font-sans text-sm">
                <p class="mt-1.5 text-xs text-surface-400 font-sans">Enter a topic and the AI will analyze and compare how each document handles it.</p>
            </div>

            <!-- Mode Toggle (Pill Style) -->
            <div>
                <label class="block text-sm font-medium text-surface-700 mb-2 font-sans">Comparison Mode</label>
                <div class="inline-flex rounded-lg border border-surface-200 bg-surface-50 p-1">
                    <label class="relative cursor-pointer">
                        <input type="radio" name="mode" value="ai" id="mode-ai" checked class="peer sr-only">
                        <div class="flex items-center gap-1.5 px-4 py-2 rounded-md text-sm font-medium text-surface-500 peer-checked:bg-copper-600 peer-checked:text-white transition-all">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            <span>AI Analysis</span>
                        </div>
                    </label>
                    <label class="relative cursor-pointer">
                        <input type="radio" name="mode" value="text" id="mode-text" class="peer sr-only">
                        <div class="flex items-center gap-1.5 px-4 py-2 rounded-md text-sm font-medium text-surface-500 peer-checked:bg-copper-600 peer-checked:text-white transition-all">
                            <i data-lucide="type" class="w-4 h-4"></i>
                            <span>Text Search</span>
                        </div>
                    </label>
                </div>
                <p class="mt-2 text-xs text-surface-400 font-sans">
                    <span class="font-medium text-surface-500">AI Analysis</span> &mdash; Claude analyzes and explains the differences.
                    <span class="font-medium text-surface-500 ml-2">Text Search</span> &mdash; Shows raw text matches.
                </p>
            </div>

            <!-- Submit -->
            <div>
                <button type="submit"
                        class="inline-flex items-center px-5 py-2.5 bg-copper-600 hover:bg-copper-700 text-white text-sm font-medium rounded-lg transition-colors font-sans">
                    <i data-lucide="columns-2" class="w-4 h-4 mr-2"></i>
                    Compare
                    <span id="compare-spinner" class="htmx-indicator ml-2">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                    </span>
                </button>
            </div>
        </form>
    </div>

    <!-- Export Buttons -->
    {% if ai_result and ai_result.analysis and topic %}
    <div class="flex justify-end gap-2" id="compare-export-buttons">
        <a href="/compare/export-ai?topic={{ topic | urlencode }}&format=html{% for doc in ai_result.documents %}&doc_ids={{ doc.file_id if doc.file_id else doc }}{% endfor %}"
           class="inline-flex items-center px-4 py-2 border border-surface-200 rounded-lg text-sm font-medium text-surface-600 bg-surface-0 hover:bg-surface-50 transition-colors font-sans">
            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
            Export HTML
        </a>
        <a href="/compare/export-ai?topic={{ topic | urlencode }}&format=docx{% for doc in ai_result.documents %}&doc_ids={{ doc.file_id if doc.file_id else doc }}{% endfor %}"
           class="inline-flex items-center px-4 py-2 border border-surface-200 rounded-lg text-sm font-medium text-surface-600 bg-surface-0 hover:bg-surface-50 transition-colors font-sans">
            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
            Export DOCX
        </a>
    </div>
    {% elif (result or multi_result) and topic %}
    <div class="flex justify-end gap-2" id="compare-export-buttons">
        <a href="/compare/export?topic={{ topic | urlencode }}&format=html{% if multi_result %}{% for doc in multi_result.documents %}&doc_ids={{ doc.file_id }}{% endfor %}{% elif result %}&doc_a={{ result.doc_a.file_id }}&doc_b={{ result.doc_b.file_id }}{% endif %}"
           class="inline-flex items-center px-4 py-2 border border-surface-200 rounded-lg text-sm font-medium text-surface-600 bg-surface-0 hover:bg-surface-50 transition-colors font-sans">
            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
            Export HTML
        </a>
        <a href="/compare/export?topic={{ topic | urlencode }}&format=docx{% if multi_result %}{% for doc in multi_result.documents %}&doc_ids={{ doc.file_id }}{% endfor %}{% elif result %}&doc_a={{ result.doc_a.file_id }}&doc_b={{ result.doc_b.file_id }}{% endif %}"
           class="inline-flex items-center px-4 py-2 border border-surface-200 rounded-lg text-sm font-medium text-surface-600 bg-surface-0 hover:bg-surface-50 transition-colors font-sans">
            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
            Export DOCX
        </a>
    </div>
    {% endif %}

    <!-- Comparison Results -->
    <div id="compare-results">
        {% if not documents %}
        <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
            <div class="flex items-start gap-3">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-copper-600 mt-0.5 shrink-0"></i>
                <div>
                    <h3 class="text-sm font-medium text-surface-800 font-sans">No indexed documents</h3>
                    <p class="mt-1 text-sm text-surface-500 font-sans">
                        Index at least two documents on the <a href="/documents" class="text-copper-600 hover:text-copper-700 underline underline-offset-2">Documents</a> page before comparing.
                    </p>
                </div>
            </div>
        </div>
        {% elif ai_result %}
            {% include "components/compare_ai_results.html" %}
        {% elif result or multi_result %}
            {% include "components/compare_results.html" %}
        {% else %}
        <div class="bg-surface-0 border border-surface-200 rounded-lg p-12 text-center">
            <div class="mx-auto h-14 w-14 bg-copper-50 rounded-full flex items-center justify-center">
                <i data-lucide="sparkles" class="w-7 h-7 text-copper-600"></i>
            </div>
            <h3 class="mt-5 text-lg font-serif text-surface-800">AI-Powered Contract Comparison</h3>
            <p class="mt-2 text-sm text-surface-500 max-w-md mx-auto font-sans">
                Select two or more documents, enter a topic (e.g., "wages", "overtime", "benefits"),
                and the AI will analyze and compare how each contract addresses it.
            </p>
            <p class="mt-4 text-xs text-surface-400 font-sans">
                Example: "Compare wages between St Albert and Spruce Grove"
            </p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
