{% extends "layout.html" %}

{% block content %}
<div class="space-y-8">

    <!-- Page Header -->
    <div>
        <div class="flex items-center gap-3 mb-1">
            <i data-lucide="table-2" class="w-6 h-6 text-copper-600"></i>
            <h1 class="text-3xl font-serif text-surface-100">Matrix Compare</h1>
        </div>
        <p class="text-sm text-surface-400 font-sans ml-9">Side-by-side aspect grid across multiple collective agreements</p>
    </div>

    <!-- Selection Form Card -->
    <div class="bg-surface-800 border border-surface-700 rounded-lg p-6">
        <form id="matrix-form"
              hx-post="/matrix/compare"
              hx-target="#matrix-results"
              hx-swap="innerHTML"
              hx-indicator="#matrix-spinner"
              class="space-y-6">

            <!-- Topic Input -->
            <div>
                <label for="topic" class="block text-sm font-medium text-surface-200 mb-1.5 font-sans">Topic to Compare</label>
                <input type="text"
                       name="topic"
                       id="topic"
                       required
                       placeholder="e.g., wages, overtime, vacation, sick leave, grievance procedure"
                       class="block w-full px-4 py-2.5 border border-surface-600 rounded-lg bg-surface-800 text-surface-100 placeholder-surface-400 focus:border-copper-500 focus:ring-1 focus:ring-copper-500 font-sans text-sm">
                <p class="mt-1.5 text-xs text-surface-400 font-sans">
                    Enter a topic and the AI will extract how each document addresses it, displayed in a comparison grid.
                </p>
            </div>

            <!-- Document Selection -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-surface-200 font-sans">Select Documents <span class="text-surface-400 font-normal">(at least 2)</span></label>
                    <button type="button"
                            onclick="toggleSelectAll()"
                            id="select-all-btn"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-md text-surface-300 bg-surface-900 border border-surface-700 hover:bg-surface-700 transition-colors font-sans">
                        <i data-lucide="check-square" class="w-3.5 h-3.5"></i>
                        Select All
                    </button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-1 max-h-64 overflow-y-auto border border-surface-700 rounded-lg p-3 bg-surface-900">
                    {% for doc in documents %}
                    <label class="flex items-center gap-2.5 px-2.5 py-2 rounded-md hover:bg-surface-700 cursor-pointer transition-colors">
                        <input type="checkbox"
                               name="file_ids"
                               value="{{ doc.id }}"
                               class="doc-checkbox h-4 w-4 text-copper-600 focus:ring-copper-500 border-surface-600 rounded shrink-0">
                        <span class="text-sm text-surface-200 truncate font-sans" title="{{ doc.filename }}">
                            {{ doc.short_name or doc.filename }}
                        </span>
                    </label>
                    {% endfor %}
                </div>
                {% if not documents %}
                <p class="text-sm text-surface-400 italic mt-2 font-sans">No indexed documents available. Index documents first from the
                    <a href="/documents" class="text-copper-600 hover:text-copper-400 underline underline-offset-2">Documents</a> page.
                </p>
                {% endif %}
                <p class="mt-1.5 text-xs text-surface-400 font-sans" id="selected-count">0 documents selected</p>
            </div>

            <!-- Submit -->
            <div>
                <button type="submit"
                        class="inline-flex items-center px-5 py-2.5 bg-copper-600 hover:bg-copper-700 text-white text-sm font-medium rounded-lg transition-colors font-sans">
                    <i data-lucide="table-2" class="w-4 h-4 mr-2"></i>
                    Build Matrix
                    <span id="matrix-spinner" class="htmx-indicator ml-2">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                    </span>
                </button>
            </div>
        </form>
    </div>

    <!-- Matrix Results -->
    <div id="matrix-results">
        {% if not documents %}
        <div class="bg-surface-800 border border-surface-700 rounded-lg p-6">
            <div class="flex items-start gap-3">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-copper-600 mt-0.5 shrink-0"></i>
                <div>
                    <h3 class="text-sm font-medium text-surface-100 font-sans">No indexed documents</h3>
                    <p class="mt-1 text-sm text-surface-400 font-sans">
                        Index at least two documents on the <a href="/documents" class="text-copper-600 hover:text-copper-400 underline underline-offset-2">Documents</a> page before using Matrix Compare.
                    </p>
                </div>
            </div>
        </div>
        {% else %}
        <div class="bg-surface-800 border border-surface-700 rounded-lg p-12 text-center">
            <div class="mx-auto h-14 w-14 bg-copper-900/20 rounded-full flex items-center justify-center">
                <i data-lucide="table-2" class="w-7 h-7 text-copper-600"></i>
            </div>
            <h3 class="mt-5 text-lg font-serif text-surface-100">Matrix Comparison Grid</h3>
            <p class="mt-2 text-sm text-surface-400 max-w-md mx-auto font-sans">
                Select two or more documents, enter a topic (e.g., "wages", "overtime", "benefits"),
                and the AI will build a structured comparison grid showing how each contract addresses each aspect.
            </p>
            <p class="mt-4 text-xs text-surface-400 font-sans">
                Results are displayed as an aspect-by-document table you can export.
            </p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    // Select All / Deselect All toggle
    function toggleSelectAll() {
        const boxes = document.querySelectorAll('.doc-checkbox');
        const allChecked = [...boxes].every(cb => cb.checked);
        boxes.forEach(cb => cb.checked = !allChecked);
        updateSelectedCount();
        const btn = document.getElementById('select-all-btn');
        if (btn) {
            btn.querySelector('span') || null;
            btn.childNodes[btn.childNodes.length - 1].textContent =
                allChecked ? ' Select All' : ' Deselect All';
        }
    }

    // Live counter
    function updateSelectedCount() {
        const count = document.querySelectorAll('.doc-checkbox:checked').length;
        const el = document.getElementById('selected-count');
        if (el) el.textContent = count + ' document' + (count !== 1 ? 's' : '') + ' selected';
    }

    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('doc-checkbox')) updateSelectedCount();
    });
</script>
{% endblock %}
