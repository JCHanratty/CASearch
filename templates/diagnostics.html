{% extends "layout.html" %}

{% block content %}
<div class="space-y-8">

    <!-- Header -->
    <div class="border-b border-surface-200 pb-6">
        <div class="flex items-center gap-3 mb-2">
            <i data-lucide="settings" class="w-5 h-5 text-copper-600"></i>
            <p class="text-sm font-sans font-medium text-copper-600 tracking-wide uppercase">Administration</p>
        </div>
        <h1 class="font-serif text-3xl text-surface-900">Diagnostics</h1>
        <p class="mt-2 font-sans text-surface-500 text-sm">System configuration and health status</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Configuration -->
        <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
            <h2 class="font-serif text-lg text-surface-800 mb-5 flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5 text-copper-600"></i>
                Configuration
            </h2>
            <dl class="space-y-4">
                {% for key, value in config.items() %}
                <div>
                    <dt class="font-sans text-xs font-medium text-surface-400 uppercase tracking-wide">{{ key }}</dt>
                    <dd class="mt-1 font-sans text-sm text-surface-800 font-mono bg-surface-50 p-2 rounded-lg border border-surface-100">{{ value }}</dd>
                </div>
                {% endfor %}
            </dl>
        </div>

        <!-- Database Stats -->
        <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
            <h2 class="font-serif text-lg text-surface-800 mb-5 flex items-center gap-2">
                <i data-lucide="database" class="w-5 h-5 text-copper-600"></i>
                Database Statistics
            </h2>
            <dl class="space-y-3">
                <div class="flex justify-between items-center p-3 bg-surface-50 rounded-lg border border-surface-100">
                    <dt class="font-sans text-sm text-surface-500">Total Files</dt>
                    <dd class="font-sans text-sm font-semibold text-surface-800">{{ stats.total_files }}</dd>
                </div>
                <div class="flex justify-between items-center p-3 bg-surface-50 rounded-lg border border-surface-100">
                    <dt class="font-sans text-sm text-surface-500">Indexed Files</dt>
                    <dd class="font-sans text-sm font-semibold text-copper-600">{{ stats.indexed_files }}</dd>
                </div>
                <div class="flex justify-between items-center p-3 bg-surface-50 rounded-lg border border-surface-100">
                    <dt class="font-sans text-sm text-surface-500">Error Files</dt>
                    <dd class="font-sans text-sm font-semibold {% if stats.error_files > 0 %}text-red-600{% else %}text-surface-800{% endif %}">
                        {{ stats.error_files }}
                    </dd>
                </div>
                <div class="flex justify-between items-center p-3 bg-surface-50 rounded-lg border border-surface-100">
                    <dt class="font-sans text-sm text-surface-500">Total Pages Indexed</dt>
                    <dd class="font-sans text-sm font-semibold text-surface-800">{{ stats.total_pages }}</dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- System Health -->
    <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
        <h2 class="font-serif text-lg text-surface-800 mb-5 flex items-center gap-2">
            <i data-lucide="shield-check" class="w-5 h-5 text-copper-600"></i>
            System Health
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Database Status -->
            <div class="flex items-center gap-4 p-4 bg-surface-50 border border-surface-200 rounded-lg">
                <i data-lucide="check-circle" class="w-6 h-6 text-green-600 flex-shrink-0"></i>
                <div>
                    <p class="font-sans text-sm font-semibold text-surface-800">Database</p>
                    <p class="font-sans text-xs text-surface-500">Connected (SQLite)</p>
                </div>
            </div>

            <!-- API Key Status -->
            <div class="flex items-center gap-4 p-4 bg-surface-50 border border-surface-200 rounded-lg">
                {% if config.ANTHROPIC_API_KEY != 'Not set' %}
                <i data-lucide="check-circle" class="w-6 h-6 text-green-600 flex-shrink-0"></i>
                {% else %}
                <i data-lucide="alert-triangle" class="w-6 h-6 text-amber-500 flex-shrink-0"></i>
                {% endif %}
                <div>
                    <p class="font-sans text-sm font-semibold text-surface-800">Anthropic API</p>
                    <p class="font-sans text-xs text-surface-500">
                        {% if config.ANTHROPIC_API_KEY != 'Not set' %}Configured{% else %}Not configured{% endif %}
                    </p>
                </div>
            </div>

            <!-- FTS Index Status -->
            <div class="flex items-center gap-4 p-4 bg-surface-50 border border-surface-200 rounded-lg">
                {% if fts_status.in_sync %}
                <i data-lucide="check-circle" class="w-6 h-6 text-green-600 flex-shrink-0"></i>
                {% else %}
                <i data-lucide="x-circle" class="w-6 h-6 text-red-500 flex-shrink-0"></i>
                {% endif %}
                <div>
                    <p class="font-sans text-sm font-semibold text-surface-800">Search Index</p>
                    <p class="font-sans text-xs text-surface-500">
                        {% if fts_status.in_sync %}FTS5 Synced{% else %}Out of Sync{% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- FTS Index Details -->
    <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-5">
            <h2 class="font-serif text-lg text-surface-800 flex items-center gap-2">
                <i data-lucide="search" class="w-5 h-5 text-copper-600"></i>
                Search Index (FTS)
            </h2>
            <form method="POST" action="/admin/rebuild-fts">
                <button type="submit"
                        class="px-4 py-2 bg-copper-600 hover:bg-copper-700 text-white font-sans text-sm font-medium rounded-lg transition-colors">
                    Rebuild FTS Index
                </button>
            </form>
        </div>

        {% if rebuild_result %}
        <div class="mb-4 p-4 bg-surface-50 border border-green-200 rounded-lg">
            <div class="flex items-center gap-2">
                <i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>
                <p class="font-sans text-sm text-green-800">
                    FTS index rebuilt successfully. {{ rebuild_result.pages_indexed }} pages indexed.
                </p>
            </div>
        </div>
        {% endif %}

        {% if fts_status.in_sync %}
        <p class="font-sans text-sm text-surface-500">All indexed documents are properly synced with the search index.</p>
        {% else %}
        <div class="bg-surface-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center gap-2 mb-3">
                <i data-lucide="alert-triangle" class="w-4 h-4 text-red-500"></i>
                <p class="font-sans text-sm font-medium text-red-800">
                    The following documents are out of sync with the search index:
                </p>
            </div>
            <table class="w-full font-sans text-sm">
                <thead>
                    <tr class="text-left text-surface-500">
                        <th class="pb-2 font-medium">Document</th>
                        <th class="pb-2 font-medium">PDF Pages</th>
                        <th class="pb-2 font-medium">FTS Pages</th>
                        <th class="pb-2 font-medium">Missing</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in fts_status.out_of_sync %}
                    <tr class="border-t border-surface-200">
                        <td class="py-2 text-surface-800">{{ doc.filename }}</td>
                        <td class="py-2 text-surface-600">{{ doc.pdf_pages }}</td>
                        <td class="py-2 text-surface-600">{{ doc.fts_pages }}</td>
                        <td class="py-2 text-red-600 font-medium">{{ doc.pdf_pages - doc.fts_pages }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p class="mt-3 font-sans text-sm text-red-700">
                Click "Rebuild FTS Index" to fix this issue.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Synonym Status -->
    <div class="bg-surface-0 border border-surface-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-5">
            <h2 class="font-serif text-lg text-surface-800 flex items-center gap-2">
                <i data-lucide="book-a" class="w-5 h-5 text-copper-600"></i>
                Search Synonyms
            </h2>
            <a href="/admin/synonyms"
               class="px-4 py-2 bg-copper-600 hover:bg-copper-700 text-white font-sans text-sm font-medium rounded-lg transition-colors">
                Manage Synonyms
            </a>
        </div>

        <p class="font-sans text-sm text-surface-500 mb-5">Synonyms improve search by matching related terms (e.g., "vacation" finds "PTO", "time off").</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="flex items-center gap-4 p-4 bg-surface-50 border border-surface-200 rounded-lg">
                <i data-lucide="lock" class="w-5 h-5 text-surface-400 flex-shrink-0"></i>
                <div>
                    <p class="font-sans text-xs text-surface-400 uppercase tracking-wide">Built-in</p>
                    <p class="font-sans text-xl font-semibold text-surface-800">{{ builtin_count }}</p>
                </div>
            </div>

            <div class="flex items-center gap-4 p-4 bg-surface-50 border border-surface-200 rounded-lg">
                <i data-lucide="plus" class="w-5 h-5 text-copper-500 flex-shrink-0"></i>
                <div>
                    <p class="font-sans text-xs text-surface-400 uppercase tracking-wide">Custom</p>
                    <p class="font-sans text-xl font-semibold text-copper-600">{{ custom_count }}</p>
                </div>
            </div>

            <div class="flex items-center gap-4 p-4 bg-surface-50 border border-surface-200 rounded-lg">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-600 flex-shrink-0"></i>
                <div>
                    <p class="font-sans text-xs text-surface-400 uppercase tracking-wide">Total Active</p>
                    <p class="font-sans text-xl font-semibold text-surface-800">{{ total_count }}</p>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}
